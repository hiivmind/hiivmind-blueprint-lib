# Core Expression Precondition
# Arbitrary boolean expression evaluation

schema_version: "1.0"
category: core/expression
description: Flexible expression-based precondition evaluation

preconditions:
  # --------------------------------------------------------------------------
  # evaluate_expression
  # --------------------------------------------------------------------------
  - type: evaluate_expression
    description:
      brief: Evaluate arbitrary boolean expression
      detail: |
        Evaluates a boolean expression string with access to state variables.
        Supports comparisons, logical operators, and built-in functions.
        Use for complex conditions that don't fit standard precondition types.
      notes:
        - Field access via dot notation: source_type, computed.count
        - Comparisons: ==, !=, >, <, >=, <=
        - Logical: &&, ||, !
        - Functions: len(), contains(), startswith(), endswith()
        - Use sparingly; prefer typed preconditions when possible

    parameters:
      - name: expression
        type: string
        required: true
        description: Boolean expression to evaluate
        interpolatable: false

    evaluation:
      effect: |
        # Parse and evaluate expression with state context
        result = eval_expression(expression, state)
        return boolean(result)
      reads:
        - "varies by expression content"
      functions:
        - eval_expression
        - len
        - contains
        - startswith
        - endswith

    examples:
      - title: Check source count
        yaml: |
          - type: evaluate_expression
            expression: "len(config.sources) == 0"
        context:
          state:
            config:
              sources: []
        result: true

      - title: Check string content
        yaml: |
          - type: evaluate_expression
            expression: "source_type == 'git' && contains(source_url, 'github.com')"
        context:
          state:
            source_type: "git"
            source_url: "https://github.com/pola-rs/polars"
        result: true

      - title: Check computed value
        yaml: |
          - type: evaluate_expression
            expression: "computed.manifest.page_count > 50"
        context:
          state:
            computed:
              manifest:
                page_count: 127
        result: true

      - title: Complex condition
        yaml: |
          - type: evaluate_expression
            expression: "!flags.error_occurred && (computed.file_count > 0 || flags.force_rebuild)"
        context:
          state:
            flags:
              error_occurred: false
              force_rebuild: false
            computed:
              file_count: 42
        result: true

      - title: String matching
        yaml: |
          - type: evaluate_expression
            expression: "startswith(source_url, 'https://') && endswith(source_url, '.git')"
        context:
          state:
            source_url: "https://github.com/pola-rs/polars.git"
        result: true

    related:
      - state_equals
      - all_of
      - any_of
    since: "1.0.0"
