# Core State Preconditions
# State inspection and comparison checks

schema_version: "1.0"
category: core/state
description: State inspection preconditions for workflow branching

preconditions:
  # --------------------------------------------------------------------------
  # flag_set
  # --------------------------------------------------------------------------
  - type: flag_set
    description:
      brief: Check if a boolean flag is true
      detail: |
        Evaluates to true if the specified flag in state.flags is true.
        Used for simple boolean conditions in workflow branching.
      notes:
        - Checks state.flags[flag]
        - Returns false if flag is undefined or false
        - Flags are typically set via set_flag consequence

    parameters:
      - name: flag
        type: string
        required: true
        description: Flag name in state.flags namespace
        pattern: "^[a-zA-Z_][a-zA-Z0-9_]*$"
        interpolatable: false

    evaluation:
      effect: |
        return state.flags[flag] == true
      reads:
        - "state.flags.${flag}"
      functions: []

    examples:
      - title: Check if config was found
        yaml: |
          - type: flag_set
            flag: config_found
        context:
          state:
            flags:
              config_found: true
        result: true

      - title: Flag not set
        yaml: |
          - type: flag_set
            flag: needs_update
        context:
          state:
            flags: {}
        result: false

    related:
      - flag_not_set
      - state_equals
    since: "1.0.0"

  # --------------------------------------------------------------------------
  # flag_not_set
  # --------------------------------------------------------------------------
  - type: flag_not_set
    description:
      brief: Check if a boolean flag is false or undefined
      detail: |
        Evaluates to true if the specified flag in state.flags is false or undefined.
        Inverse of flag_set.
      notes:
        - Returns true if flag is false, undefined, or null
        - Use for negative conditions

    parameters:
      - name: flag
        type: string
        required: true
        description: Flag name in state.flags namespace
        pattern: "^[a-zA-Z_][a-zA-Z0-9_]*$"
        interpolatable: false

    evaluation:
      effect: |
        return state.flags[flag] != true
      reads:
        - "state.flags.${flag}"
      functions: []

    examples:
      - title: Check flag is not set
        yaml: |
          - type: flag_not_set
            flag: config_found
        context:
          state:
            flags: {}
        result: true

      - title: Flag explicitly false
        yaml: |
          - type: flag_not_set
            flag: needs_update
        context:
          state:
            flags:
              needs_update: false
        result: true

    related:
      - flag_set
      - state_is_null
    since: "1.0.0"

  # --------------------------------------------------------------------------
  # state_equals
  # --------------------------------------------------------------------------
  - type: state_equals
    description:
      brief: Check if state field equals specific value
      detail: |
        Evaluates to true if the state field at the given path equals
        the specified value. Supports dot notation for nested fields.
      notes:
        - Supports dot notation (e.g., computed.source.type)
        - Uses strict equality comparison
        - Value can be any type (string, number, boolean, null)

    parameters:
      - name: field
        type: string
        required: true
        description: Field path (dot notation for nested)
        pattern: "^[a-zA-Z_][a-zA-Z0-9_.]*$"
        interpolatable: false

      - name: value
        type: any
        required: true
        description: Expected value
        interpolatable: false

    evaluation:
      effect: |
        actual = get_state_value(field)
        return actual == value
      reads:
        - "state.${field}"
      functions:
        - get_state_value

    examples:
      - title: Check source type
        yaml: |
          - type: state_equals
            field: source_type
            value: git
        context:
          state:
            source_type: "git"
        result: true

      - title: Check nested field
        yaml: |
          - type: state_equals
            field: computed.manifest.format
            value: "mkdocs"
        context:
          state:
            computed:
              manifest:
                format: "mkdocs"
        result: true

      - title: Numeric comparison
        yaml: |
          - type: state_equals
            field: computed.file_count
            value: 0
        context:
          state:
            computed:
              file_count: 0
        result: true

    related:
      - state_not_null
      - state_is_null
      - flag_set
    since: "1.0.0"

  # --------------------------------------------------------------------------
  # state_not_null
  # --------------------------------------------------------------------------
  - type: state_not_null
    description:
      brief: Check if state field has a value
      detail: |
        Evaluates to true if the state field at the given path is not null
        or undefined. Used to verify computed values exist.
      notes:
        - Returns true for any non-null value including empty strings
        - Supports dot notation for nested paths

    parameters:
      - name: field
        type: string
        required: true
        description: Field path
        pattern: "^[a-zA-Z_][a-zA-Z0-9_.]*$"
        interpolatable: false

    evaluation:
      effect: |
        return get_state_value(field) != null
      reads:
        - "state.${field}"
      functions:
        - get_state_value

    examples:
      - title: Check computed value exists
        yaml: |
          - type: state_not_null
            field: computed.source_url
        context:
          state:
            computed:
              source_url: "https://github.com/pola-rs/polars"
        result: true

      - title: Field is null
        yaml: |
          - type: state_not_null
            field: computed.error
        context:
          state:
            computed:
              error: null
        result: false

    related:
      - state_is_null
      - state_equals
    since: "1.0.0"

  # --------------------------------------------------------------------------
  # state_is_null
  # --------------------------------------------------------------------------
  - type: state_is_null
    description:
      brief: Check if state field is null or undefined
      detail: |
        Evaluates to true if the state field at the given path is null
        or undefined. Inverse of state_not_null.
      notes:
        - Returns true for null or undefined
        - Returns false for empty strings or zero

    parameters:
      - name: field
        type: string
        required: true
        description: Field path
        pattern: "^[a-zA-Z_][a-zA-Z0-9_.]*$"
        interpolatable: false

    evaluation:
      effect: |
        return get_state_value(field) == null
      reads:
        - "state.${field}"
      functions:
        - get_state_value

    examples:
      - title: Check no error present
        yaml: |
          - type: state_is_null
            field: computed.error
        context:
          state:
            computed:
              error: null
        result: true

      - title: Undefined field
        yaml: |
          - type: state_is_null
            field: computed.not_set
        context:
          state:
            computed: {}
        result: true

    related:
      - state_not_null
      - flag_not_set
    since: "1.0.0"

  # --------------------------------------------------------------------------
  # count_equals
  # --------------------------------------------------------------------------
  - type: count_equals
    description:
      brief: Check if array length equals value
      detail: |
        Evaluates to true if the length of the array at the specified
        field path equals the given count.
      notes:
        - Field must contain an array
        - Returns false if field is null or not an array

    parameters:
      - name: field
        type: string
        required: true
        description: Field containing array
        pattern: "^[a-zA-Z_][a-zA-Z0-9_.]*$"
        interpolatable: false

      - name: count
        type: number
        required: true
        description: Expected length
        interpolatable: false

    evaluation:
      effect: |
        array = get_state_value(field)
        if array == null or not is_array(array):
          return false
        return len(array) == count
      reads:
        - "state.${field}"
      functions:
        - get_state_value
        - len
        - is_array

    examples:
      - title: Check for empty sources
        yaml: |
          - type: count_equals
            field: computed.sources
            count: 0
        context:
          state:
            computed:
              sources: []
        result: true

      - title: Check for exactly 3 items
        yaml: |
          - type: count_equals
            field: computed.errors
            count: 3
        context:
          state:
            computed:
              errors: ["a", "b", "c"]
        result: true

    related:
      - count_above
      - count_below
    since: "1.0.0"

  # --------------------------------------------------------------------------
  # count_above
  # --------------------------------------------------------------------------
  - type: count_above
    description:
      brief: Check if array length exceeds threshold
      detail: |
        Evaluates to true if the length of the array at the specified
        field path is greater than the minimum value (exclusive).
      notes:
        - Uses > comparison (min is exclusive)
        - Returns false if field is null or not an array

    parameters:
      - name: field
        type: string
        required: true
        description: Field containing array
        pattern: "^[a-zA-Z_][a-zA-Z0-9_.]*$"
        interpolatable: false

      - name: min
        type: number
        required: true
        description: Minimum length (exclusive)
        interpolatable: false

    evaluation:
      effect: |
        array = get_state_value(field)
        if array == null or not is_array(array):
          return false
        return len(array) > min
      reads:
        - "state.${field}"
      functions:
        - get_state_value
        - len
        - is_array

    examples:
      - title: Check for many URLs
        yaml: |
          - type: count_above
            field: computed.discovered_urls
            min: 100
        context:
          state:
            computed:
              discovered_urls: ["url1", "url2"]  # ... 150 items
        result: true

      - title: Check has at least one source
        yaml: |
          - type: count_above
            field: config.sources
            min: 0
        context:
          state:
            config:
              sources: ["polars"]
        result: true

    related:
      - count_equals
      - count_below
    since: "1.0.0"

  # --------------------------------------------------------------------------
  # count_below
  # --------------------------------------------------------------------------
  - type: count_below
    description:
      brief: Check if array length is below threshold
      detail: |
        Evaluates to true if the length of the array at the specified
        field path is less than the maximum value (exclusive).
      notes:
        - Uses < comparison (max is exclusive)
        - Returns false if field is null or not an array

    parameters:
      - name: field
        type: string
        required: true
        description: Field containing array
        pattern: "^[a-zA-Z_][a-zA-Z0-9_.]*$"
        interpolatable: false

      - name: max
        type: number
        required: true
        description: Maximum length (exclusive)
        interpolatable: false

    evaluation:
      effect: |
        array = get_state_value(field)
        if array == null or not is_array(array):
          return false
        return len(array) < max
      reads:
        - "state.${field}"
      functions:
        - get_state_value
        - len
        - is_array

    examples:
      - title: Check few errors
        yaml: |
          - type: count_below
            field: computed.errors
            max: 5
        context:
          state:
            computed:
              errors: ["a", "b"]
        result: true

      - title: Check manageable source count
        yaml: |
          - type: count_below
            field: config.sources
            max: 10
        context:
          state:
            config:
              sources: ["polars", "ibis", "narwhals"]
        result: true

    related:
      - count_equals
      - count_above
    since: "1.0.0"
