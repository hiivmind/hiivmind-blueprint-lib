# Extension: Web Preconditions
# Web fetch result checks

schema_version: "1.0"
category: extensions/web
description: Web fetch result verification preconditions

preconditions:
  # --------------------------------------------------------------------------
  # fetch_succeeded
  # --------------------------------------------------------------------------
  - type: fetch_succeeded
    description:
      brief: Check if a previous web fetch succeeded
      detail: |
        Evaluates to true if a previous web_fetch operation stored in state
        completed successfully with a 2xx status code.
      notes:
        - Checks state field for fetch result object
        - Expects status field in range 200-299
        - Field must contain result from web_fetch consequence

    parameters:
      - name: from
        type: string
        required: true
        description: State field containing fetch result
        pattern: "^[a-zA-Z_][a-zA-Z0-9_.]*$"
        interpolatable: false

    evaluation:
      effect: |
        result = get_state_value(from)
        if result == null:
          return false
        status = result.status
        return status >= 200 and status < 300
      reads:
        - "state.${from}"
      functions:
        - get_state_value

    examples:
      - title: Check manifest fetch succeeded
        yaml: |
          - type: fetch_succeeded
            from: computed.manifest_check
        context:
          state:
            computed:
              manifest_check:
                status: 200
                content: "..."
        result: true

      - title: Fetch failed with 404
        yaml: |
          - type: fetch_succeeded
            from: computed.api_result
        context:
          state:
            computed:
              api_result:
                status: 404
                content: null
        result: false

      - title: No fetch result
        yaml: |
          - type: fetch_succeeded
            from: computed.uncached
        context:
          state:
            computed: {}
        result: false

    related:
      - fetch_returned_content
      - state_not_null
    since: "1.0.0"

  # --------------------------------------------------------------------------
  # fetch_returned_content
  # --------------------------------------------------------------------------
  - type: fetch_returned_content
    description:
      brief: Check if fetch returned non-empty content
      detail: |
        Evaluates to true if a previous web_fetch operation returned
        non-empty content. Checks that content field is not null and
        has length > 0.
      notes:
        - More specific than fetch_succeeded
        - Verifies actual content was received
        - Useful for detecting empty responses

    parameters:
      - name: from
        type: string
        required: true
        description: State field containing fetch result
        pattern: "^[a-zA-Z_][a-zA-Z0-9_.]*$"
        interpolatable: false

    evaluation:
      effect: |
        result = get_state_value(from)
        if result == null:
          return false
        content = result.content
        return content != null and len(content) > 0
      reads:
        - "state.${from}"
      functions:
        - get_state_value
        - len

    examples:
      - title: Check llms.txt has content
        yaml: |
          - type: fetch_returned_content
            from: computed.llms_txt
        context:
          state:
            computed:
              llms_txt:
                status: 200
                content: "# Title\n\nContent here..."
        result: true

      - title: Empty content response
        yaml: |
          - type: fetch_returned_content
            from: computed.empty_response
        context:
          state:
            computed:
              empty_response:
                status: 200
                content: ""
        result: false

      - title: Null content
        yaml: |
          - type: fetch_returned_content
            from: computed.failed_fetch
        context:
          state:
            computed:
              failed_fetch:
                status: 500
                content: null
        result: false

    related:
      - fetch_succeeded
      - state_not_null
    since: "1.0.0"
