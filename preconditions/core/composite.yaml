# Core Composite Preconditions
# Logical combinators for precondition composition

schema_version: "1.0"
category: core/composite
description: Logical composition of multiple preconditions

preconditions:
  # --------------------------------------------------------------------------
  # all_of
  # --------------------------------------------------------------------------
  - type: all_of
    description:
      brief: All nested conditions must be true (AND)
      detail: |
        Evaluates to true only if all nested conditions evaluate to true.
        Implements logical AND operation with short-circuit evaluation.
      notes:
        - Short-circuits on first false condition
        - Empty conditions array evaluates to true
        - Recursive - nested conditions can be any precondition type

    parameters:
      - name: conditions
        type: array
        required: true
        description: Array of precondition objects
        interpolatable: false

    evaluation:
      effect: |
        for condition in conditions:
          if not evaluate(condition):
            return false
        return true
      reads:
        - "varies by nested conditions"
      functions:
        - evaluate

    examples:
      - title: Check multiple requirements
        yaml: |
          - type: all_of
            conditions:
              - type: config_exists
              - type: tool_available
                tool: git
              - type: flag_set
                flag: config_found
        context:
          state:
            flags:
              config_found: true
          files:
            "data/config.yaml": true
        result: true

      - title: Combined file and state check
        yaml: |
          - type: all_of
            conditions:
              - type: file_exists
                path: ".source/${source_id}/README.md"
              - type: state_not_null
                field: computed.sha
        context:
          state:
            source_id: "polars"
            computed:
              sha: "abc123"
          files:
            ".source/polars/README.md": true
        result: true

    related:
      - any_of
      - none_of
      - xor_of
    since: "1.0.0"

  # --------------------------------------------------------------------------
  # any_of
  # --------------------------------------------------------------------------
  - type: any_of
    description:
      brief: At least one condition must be true (OR)
      detail: |
        Evaluates to true if at least one nested condition evaluates to true.
        Implements logical OR operation with short-circuit evaluation.
      notes:
        - Short-circuits on first true condition
        - Empty conditions array evaluates to false
        - Recursive - nested conditions can be any precondition type

    parameters:
      - name: conditions
        type: array
        required: true
        description: Array of precondition objects
        interpolatable: false

    evaluation:
      effect: |
        for condition in conditions:
          if evaluate(condition):
            return true
        return false
      reads:
        - "varies by nested conditions"
      functions:
        - evaluate

    examples:
      - title: Check for any YAML processor
        yaml: |
          - type: any_of
            conditions:
              - type: tool_available
                tool: yq
              - type: python_module_available
                module: yaml
        context:
          files: {}
        result: true

      - title: Multiple valid source locations
        yaml: |
          - type: any_of
            conditions:
              - type: file_exists
                path: ".source/main/docs/index.md"
              - type: file_exists
                path: ".source/main/README.md"
              - type: file_exists
                path: ".source/main/doc/index.rst"
        context:
          files:
            ".source/main/README.md": true
        result: true

    related:
      - all_of
      - none_of
      - xor_of
    since: "1.0.0"

  # --------------------------------------------------------------------------
  # none_of
  # --------------------------------------------------------------------------
  - type: none_of
    description:
      brief: No conditions may be true (NOR)
      detail: |
        Evaluates to true only if no nested conditions evaluate to true.
        Implements logical NOR (negated OR) operation.
      notes:
        - Returns false on first true condition
        - Empty conditions array evaluates to true
        - Useful for exclusion checks

    parameters:
      - name: conditions
        type: array
        required: true
        description: Array of precondition objects
        interpolatable: false

    evaluation:
      effect: |
        for condition in conditions:
          if evaluate(condition):
            return false
        return true
      reads:
        - "varies by nested conditions"
      functions:
        - evaluate

    examples:
      - title: Ensure source doesn't already exist
        yaml: |
          - type: none_of
            conditions:
              - type: source_exists
                id: "${computed.source_id}"
              - type: directory_exists
                path: ".source/${computed.source_id}"
        context:
          state:
            computed:
              source_id: "new-source"
          files: {}
        result: true

      - title: Check no error flags set
        yaml: |
          - type: none_of
            conditions:
              - type: flag_set
                flag: parse_error
              - type: flag_set
                flag: validation_error
              - type: flag_set
                flag: fetch_error
        context:
          state:
            flags: {}
        result: true

    related:
      - all_of
      - any_of
      - xor_of
    since: "1.0.0"

  # --------------------------------------------------------------------------
  # xor_of
  # --------------------------------------------------------------------------
  - type: xor_of
    description:
      brief: Exactly one condition must be true (XOR)
      detail: |
        Evaluates to true if exactly one nested condition evaluates to true.
        Returns false if zero or more than one condition is true.
        Does not short-circuit - always evaluates all conditions.
      notes:
        - Always evaluates all conditions (no short-circuit)
        - Empty conditions array evaluates to false
        - Useful for mutually exclusive states (e.g., exactly one source type selected)
        - Recursive - nested conditions can be any precondition type

    parameters:
      - name: conditions
        type: array
        required: true
        description: Array of precondition objects
        interpolatable: false

    evaluation:
      effect: |
        true_count = 0
        for condition in conditions:
          if evaluate(condition):
            true_count += 1
        return true_count == 1
      reads:
        - "varies by nested conditions"
      functions:
        - evaluate

    examples:
      - title: Exactly one source type selected
        yaml: |
          - type: xor_of
            conditions:
              - type: flag_set
                flag: is_git_source
              - type: flag_set
                flag: is_local_source
              - type: flag_set
                flag: is_web_source
        context:
          state:
            flags:
              is_git_source: true
              is_local_source: false
              is_web_source: false
        result: true

      - title: Multiple true conditions (invalid)
        yaml: |
          - type: xor_of
            conditions:
              - type: flag_set
                flag: has_config
              - type: flag_set
                flag: has_manifest
        context:
          state:
            flags:
              has_config: true
              has_manifest: true
        result: false

      - title: No true conditions (invalid)
        yaml: |
          - type: xor_of
            conditions:
              - type: file_exists
                path: "config.yaml"
              - type: file_exists
                path: "config.json"
        context:
          files: {}
        result: false

    related:
      - all_of
      - any_of
      - none_of
    since: "2.0.0"
