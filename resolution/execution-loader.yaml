# Execution Semantics Loader
# Bootstrap sequence and selective loading for execution semantics
#
# Fetching primitives: see resolution/fetch-patterns.yaml (loaded during bootstrap Phase 3.0)
#
# v2.4.0: Unified output config replaces separate display/logging sections

schema_version: "2.0"
category: resolution

resolution:
  execution_loader:
    description:
      brief: Bootstrap sequence and selective loading for execution semantics
      detail: |
        The execution loader handles the critical first phase of workflow execution:
        loading the execution semantics that define HOW to interpret workflows.

        This creates an apparent catch-22: "need execution semantics to load execution
        semantics." The resolution is that minimal bootstrap requires only:
        1. Read workflow.yaml from provided path
        2. Extract definitions.source
        3. Parse as {owner, repo, version} or {is_local, local_path}

        This parsing is trivial string manipulation. Once source is parsed, execution
        semantics can be fetched using fetch() from resolution/fetch-patterns.yaml.

    bootstrap:
      description: Bootstrap sequence resolving the apparent catch-22

      minimal_bootstrap:
        description: Absolute minimum before loading execution semantics
        requires: workflow.yaml path only
        steps:
          - step: 1
            action: Read workflow.yaml from provided path
            note: Direct file read - no execution semantics needed
          - step: 2
            action: Extract definitions.source field
            note: Simple YAML parse - field extraction only
          - step: 3
            action: Parse source string
            note: String manipulation per parse_source() in fetch-patterns.yaml

      fetch_order:
        description: Order of operations after minimal bootstrap
        phases:
          - id: bootstrap
            description: Parse workflow.yaml, extract definitions.source
            requires: workflow.yaml path
            produces: source_parts (is_local, local_path OR owner, repo, version)

          - id: execution_semantics
            description: Fetch execution/engine_execution.yaml
            requires: source_parts
            produces: execution semantics (traversal, state, dispatch, output)

          - id: types
            description: Load type definitions per type-loader.yaml
            requires: source_parts, definitions block
            produces: TypeRegistry

          - id: initialize
            description: Initialize state, check entry preconditions
            requires: execution semantics, TypeRegistry, workflow
            produces: initial state

          - id: execute
            description: Begin execution loop per traversal semantics
            requires: all above
            produces: execution results

    section_registry:
      description: Registry of execution sections in engine_execution.yaml
      sections:
        traversal:
          required: true
          description: Core workflow execution loop
          path_in_file: "execution.traversal"
          depends_on: []

        state:
          required: true
          description: State structure and management
          path_in_file: "execution.state"
          depends_on: []

        precondition_dispatch:
          required: true
          description: Dispatch logic for precondition evaluation
          path_in_file: "execution.precondition_dispatch"
          depends_on: [state]

        consequence_dispatch:
          required: true
          description: Dispatch logic for consequence execution
          path_in_file: "execution.consequence_dispatch"
          depends_on: [state]

        output:
          required: true
          has_defaults: true
          description: Unified output configuration (logging + display)
          path_in_file: "execution.output"
          depends_on: []
          since: "2.4.0"
          replaces:
            - "execution.display (deprecated)"
            - "execution.logging (deprecated)"

        # DEPRECATED sections
        display:
          deprecated: true
          deprecated_since: "2.4.0"
          replacement: output

        logging:
          deprecated: true
          deprecated_since: "2.4.0"
          replacement: output

    loading_strategies:
      description: Strategies for loading execution semantics
      # Fetching uses fetch() from resolution/fetch-patterns.yaml (loaded during bootstrap Phase 3.0)

      full:
        description: Fetch entire engine_execution.yaml
        use_when:
          - Gateway commands (need all sections)
          - Complex skills with logging and display customization
          - Development/debugging (want complete reference)
        effect: |
          FUNCTION load_execution_full(source_parts):
              content = fetch(source_parts, "execution/engine_execution.yaml")
              RETURN content.execution

        file_size: ~2300 lines
        network_fetches: 1

      selective:
        description: Extract specific sections via yq
        use_when:
          - Simple skills (minimal footprint)
          - Logging disabled (skip logging section)
          - Performance-critical (reduce context size)
        minimal_set:
          - traversal
          - state
          - precondition_dispatch
          - consequence_dispatch

        effect: |
          FUNCTION load_execution_selective(source_parts, sections):
              # Build yq query for section extraction
              section_queries = sections.map(s => '.execution.' + s).join(', ')
              query = '{ execution: { ' + section_queries + ' } }'

              IF source_parts.is_local:
                  full_path = "{source_parts.local_path}/execution/engine_execution.yaml"
                  result = CALL Bash with:
                      command: "yq eval '{query}' {full_path}"
                  RETURN parse_yaml(result.stdout).execution
              ELSE:
                  result = CALL Bash with:
                      command: |
                          gh api repos/{owner}/{repo}/contents/execution/engine_execution.yaml?ref={version} \
                              --jq '.content' | base64 -d | yq eval '{query}' -
                  RETURN parse_yaml(result.stdout).execution

      automatic:
        description: Auto-select strategy based on workflow analysis
        effect: |
          FUNCTION load_execution_auto(source_parts, workflow):
              has_output_config = workflow.initial_state?.output != null
              has_output_flags = runtime_flags.any(f =>
                  f.startsWith("--verbose") OR f.startsWith("--quiet") OR
                  f == "--debug" OR f == "--no-log" OR f == "--no-display" OR f == "--ci")
              has_legacy_config = workflow.initial_state?.logging != null
                                  OR workflow.initial_state?.display != null

              IF has_output_config OR has_output_flags OR has_legacy_config:
                  RETURN load_execution_selective(source_parts,
                      ["traversal", "state", "precondition_dispatch", "consequence_dispatch", "output"])
              ELSE:
                  RETURN load_execution_selective(source_parts,
                      ["traversal", "state", "precondition_dispatch", "consequence_dispatch"])

    optionality:
      description: Which sections can be omitted

      output:
        required: false
        has_defaults: true
        skip_conditions:
          - No custom output config in workflow.initial_state.output
          - No output-related runtime flags provided
          - No legacy logging/display configs present
        when_skipped: "Hardcoded defaults are used (no remote fetch)"
        defaults:
          level: "normal"
          display_enabled: true
          batch_enabled: true
          batch_threshold: 3
          use_icons: true
          log_enabled: true
          log_format: "yaml"
          log_location: ".logs/"
          ci_mode: false

      logging:
        deprecated: true
        deprecated_since: "2.4.0"
        replacement: output

      display:
        deprecated: true
        deprecated_since: "2.4.0"
        replacement: output

    main_algorithm:
      description: Complete execution loading algorithm
      effect: |
        FUNCTION load_execution_semantics(workflow_path, runtime_flags):
            # Phase 1: Minimal bootstrap (no execution semantics needed)
            workflow = parse_yaml(read_file(workflow_path))
            source = workflow.definitions.source
            source_parts = parse_source(source)

            # Phase 2: Fetch execution semantics
            execution = load_execution_auto(source_parts, workflow)

            # Phase 3: Load type definitions (per type-loader.yaml)
            types = load_types_hybrid(workflow.definitions, workflow)

            # Phase 4: Initialize state per execution.state
            state = initialize_state(workflow, execution.state)

            # Phase 5: Check entry preconditions per execution.precondition_dispatch
            IF workflow.entry_preconditions:
                FOR each precondition IN workflow.entry_preconditions:
                    result = evaluate_precondition(precondition, state, types, execution.precondition_dispatch)
                    IF NOT result.satisfied:
                        THROW "Entry precondition failed: {precondition.type}"

            RETURN {
                workflow: workflow,
                execution: execution,
                types: types,
                state: state
            }

    error_messages:
      examples:
        - error: "Failed to fetch execution semantics (remote)"
          context: |
            Source: hiivmind/hiivmind-blueprint-lib@v2.0.0

            Tried:
            1. gh api repos/.../execution/engine_execution.yaml → (error)
            2. raw.githubusercontent.com fallback → (error)

            Suggestions:
            - Verify gh auth status (gh auth status)
            - Check the version exists: https://github.com/hiivmind/hiivmind-blueprint-lib/tags

        - error: "Failed to fetch execution semantics (local)"
          context: |
            Source: ./lib/blueprint

            Tried:
            1. {local_path}/execution/engine_execution.yaml → File not found

            Suggestions:
            - Verify the path exists: ls -la ./lib/blueprint/execution
            - Check for required file: engine_execution.yaml

    since: "2.0.0"
