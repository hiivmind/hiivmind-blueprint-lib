# Validation Gate Node Type Definition
# Runs multiple preconditions; all must pass to proceed

schema_version: "1.0"
category: core

nodes:
  - type: validation_gate
    description:
      brief: Runs multiple preconditions; all must pass to proceed
      detail: |
        A validation_gate node evaluates multiple preconditions. All validations
        must pass for the workflow to proceed via on_valid; if any fail, routes
        to on_invalid. Each validation can have a custom error_message for reporting.

        Use this for entry checks, pre-action validation, or any scenario requiring
        multiple conditions to be satisfied before proceeding.
      notes:
        - All validations must pass for on_valid routing
        - First failure short-circuits remaining validations
        - Error messages are collected for display on invalid
        - Different from conditional (single condition, binary branch)

    fields:
      - name: type
        type: string
        required: true
        value: "validation_gate"
        description: Node type discriminator

      - name: description
        type: string
        required: false
        description: Human-readable purpose for debugging and documentation

      - name: validations
        type: array
        required: true
        min_items: 1
        description: Array of preconditions to validate
        items:
          type: precondition
          additional_properties:
            - name: error_message
              type: string
              required: true
              description: Message to display if this validation fails

      - name: on_valid
        type: node_reference
        required: true
        description: Node or ending to route to when all validations pass

      - name: on_invalid
        type: node_reference
        required: true
        description: Node or ending to route to when any validation fails

    execution:
      effect: |
        validation_errors = []

        for validation in node.validations:
          result = evaluate_precondition(validation, state)
          if result == false:
            validation_errors.append({
              type: validation.type,
              message: validation.error_message,
              context: validation
            })

        if validation_errors.length > 0:
          state.computed.validation_errors = validation_errors
          return route_to(node.on_invalid)
        else:
          state.computed.validation_errors = []
          return route_to(node.on_valid)
      state_reads:
        - Fields referenced in validation parameters via ${} interpolation
        - Fields checked by precondition types
      state_writes:
        - "computed.validation_errors"

    examples:
      - title: Pre-operation validation
        yaml: |
          validate_environment:
            type: validation_gate
            description: Ensure environment is ready before proceeding
            validations:
              - type: file_exists
                path: "data/config.yaml"
                error_message: "Config file missing - run hiivmind-corpus-init first"
              - type: tool_available
                tool: git
                error_message: "Git is not installed"
              - type: tool_available
                tool: yq
                error_message: "yq is not installed (required for YAML processing)"
            on_valid: start_processing
            on_invalid: show_validation_errors
        explanation: |
          Validates that config.yaml exists and required tools are available.
          If all pass, proceeds to start_processing; otherwise routes to
          show_validation_errors where computed.validation_errors contains
          the list of failures.

      - title: State validation
        yaml: |
          validate_source_config:
            type: validation_gate
            description: Validate source configuration before adding
            validations:
              - type: state_not_empty
                field: source_type
                error_message: "Source type must be selected"
              - type: state_not_empty
                field: computed.source_id
                error_message: "Source ID must be generated"
              - type: flag_set
                flag: url_validated
                error_message: "URL must be validated first"
            on_valid: add_source_to_config
            on_invalid: error_incomplete_config

      - title: Permission validation
        yaml: |
          validate_write_access:
            type: validation_gate
            validations:
              - type: directory_writable
                path: "${computed.target_path}"
                error_message: "Cannot write to target directory"
              - type: file_not_exists
                path: "${computed.target_path}/${computed.filename}"
                error_message: "File already exists (use --force to overwrite)"
            on_valid: write_output
            on_invalid: permission_error

      - title: Multi-source validation
        yaml: |
          validate_sources:
            type: validation_gate
            description: Validate all configured sources are accessible
            validations:
              - type: all_of
                conditions:
                  - type: source_exists
                    source_id: "${sources[0].id}"
                  - type: source_exists
                    source_id: "${sources[1].id}"
                error_message: "One or more sources are not accessible"
            on_valid: begin_sync
            on_invalid: source_access_error

    related:
      - conditional
      - action
    since: "1.0.0"
