# Reference Node Type Definition
# Loads and executes a reference document or remote workflow
#
# Supports both local documents (doc) and remote workflows (workflow).
# See resolution/workflow-loader.yaml for remote loading protocol.

schema_version: "2.1"
category: core

nodes:
  - type: reference
    description:
      brief: Loads and executes a reference document or remote workflow
      detail: |
        A reference node delegates execution to either a local reference document
        or a remote workflow. This enables complex multi-step procedures to be
        documented separately while remaining callable from workflows.

        For local documents: typically markdown files containing detailed procedure
        instructions. Context variables are available for interpolation.

        For remote workflows: fetched from GitHub repositories, enabling distributed
        composable workflow ecosystems. See resolution/workflow-loader.yaml for
        the loading protocol.

        State is SHARED between parent and referenced workflow/document.
      notes:
        - Must specify either 'doc' (local) or 'workflow' (remote), not both
        - For local: doc path is relative to plugin root
        - For remote: uses owner/repo@version:workflow-name format
        - Section parameter only applies to doc references
        - Context variables are merged into state for sub-execution
        - State is shared (unlike invoke_skill which isolates state)
        - next_node supports variable interpolation for dynamic routing

    fields:
      - name: type
        type: string
        required: true
        value: "reference"
        description: Node type discriminator

      - name: doc
        type: string
        required_unless: workflow
        description: |
          Path to the reference document, relative to plugin root.
          Typically a markdown file in lib/ or references/ directory.
          Mutually exclusive with 'workflow'.

      - name: workflow
        type: string
        required_unless: doc
        description: |
          Remote workflow reference in format: owner/repo@version:workflow-name
          Example: hiivmind/hiivmind-blueprint-lib@v2.0.0:intent-detection
          Mutually exclusive with 'doc'.
          See resolution/workflow-loader.yaml for loading protocol.

      - name: section
        type: string
        required: false
        description: |
          Optional section heading within the document to execute.
          If omitted, the entire document is executed.
          Only applicable when using 'doc' (not 'workflow').

      - name: context
        type: object
        required: false
        description: |
          Variables to make available within the referenced document/workflow.
          These can be referenced using ${} interpolation syntax.
          For workflows, maps to workflow inputs.
        additionalProperties:
          type: any
          interpolatable: true

      - name: next_node
        type: node_reference
        required: true
        description: |
          Node or ending to route to after execution completes.
          Supports variable interpolation (e.g., "${computed.dynamic_target}").

    execution:
      effect: |
        # Determine source: remote workflow or local document
        if node.workflow:
          # Remote workflow reference (v2.1+)
          # See resolution/workflow-loader.yaml for full loading protocol
          workflow = load_workflow(node.workflow)
        else if node.doc:
          # Local file reference
          doc_path = resolve_path(plugin_root, node.doc)
          doc_content = read_file(doc_path)

          # Extract section if specified (only for doc references)
          if node.section:
            doc_content = extract_section(doc_content, node.section)
        else:
          throw Error("Reference node requires 'workflow' or 'doc' parameter")

        # Build context with interpolation
        context = {}
        if node.context:
          for key, value in node.context.items():
            context[key] = interpolate(value, state)

        # Merge context into state (for shared state execution)
        for key, value in context.items():
          state[key] = value

        # Execute based on source type
        if node.workflow:
          # Execute as sub-workflow with shared state
          # Note: Reference execution shares state (unlike invoke_skill)
          execute_workflow(workflow, types, state)
        else:
          # Execute document with context
          execute_document(doc_content, context, state)

        # Resolve next node (supports dynamic interpolation)
        target = resolve_routing_target(node.next_node, state)

        return route_to(target)
      state_reads:
        - Fields referenced in context values via ${} interpolation
      state_writes:
        - Depends on workflow/document execution
        - Remote workflows can read and modify parent state directly

    examples:
      # === Local document references ===
      - title: Execute git clone procedure (local doc)
        yaml: |
          clone_repository:
            type: reference
            doc: "lib/corpus/patterns/sources/git.md"
            section: "Clone Repository"
            context:
              repo_url: "${computed.repo_url}"
              clone_path: "${computed.clone_path}"
              branch: "${user_responses.branch}"
            next_node: verify_clone
        explanation: |
          Loads the git.md document, extracts the "Clone Repository" section,
          and executes it with the provided context variables. After completion,
          routes to verify_clone.

      - title: Full document execution (local doc)
        yaml: |
          run_build_process:
            type: reference
            doc: "references/build-index.md"
            context:
              source_paths: "${computed.source_paths}"
              output_path: "${computed.output_path}"
            next_node: finalize_build
        explanation: |
          Executes the entire build-index.md document with source and output
          paths from computed state.

      # === Remote workflow references ===
      - title: Remote workflow for intent detection
        yaml: |
          detect_intent:
            type: reference
            workflow: hiivmind/hiivmind-blueprint-lib@v2.0.0:intent-detection
            context:
              arguments: "${arguments}"
              intent_flags: "${intent_flags}"
              intent_rules: "${intent_rules}"
              fallback_action: "show_main_menu"
            next_node: execute_dynamic_route
        explanation: |
          Fetches the intent-detection workflow from hiivmind-blueprint-lib
          and executes it with context mapped as workflow inputs.
          After completion, routes to execute_dynamic_route.
          The workflow sets computed.matched_action and other outputs
          that are directly available in parent state.

      - title: Remote workflow with dynamic routing
        yaml: |
          detect_intent:
            type: reference
            workflow: hiivmind/hiivmind-blueprint-lib@v2.0.0:intent-detection
            context:
              arguments: "${arguments}"
              intent_flags: "${intent_flags}"
              intent_rules: "${intent_rules}"
            next_node: "${computed.dynamic_target}"
        explanation: |
          The next_node uses variable interpolation to route dynamically
          based on the workflow output. The intent-detection workflow sets
          computed.dynamic_target based on the matched intent.

      - title: Using outputs from remote workflow
        yaml: |
          # Parent workflow can use outputs directly after reference node
          execute_matched_intent:
            type: action
            actions:
              - type: dynamic_route
                action: "${computed.matched_action}"
            on_success: "${computed.dynamic_target}"
            on_failure: show_main_menu
        explanation: |
          After detect_intent reference node completes, the parent workflow
          has access to computed.matched_action, computed.intent_flags,
          and computed.intent_matches set by the sub-workflow.

      # === State sharing examples ===
      - title: Complex procedure with multiple context values (local doc)
        yaml: |
          process_web_source:
            type: reference
            doc: "lib/corpus/patterns/sources/web.md"
            section: "Fetch and Cache"
            context:
              urls: "${computed.discovered_urls}"
              cache_dir: "${computed.cache_directory}"
              max_depth: "${user_responses.crawl_depth}"
              include_images: "${flags.include_images}"
              user_agent: "hiivmind-corpus/1.0"
            next_node: verify_cached_content

      - title: Override logging for sub-workflow
        yaml: |
          detect_intent:
            type: reference
            workflow: hiivmind/hiivmind-blueprint-lib@v2.0.0:intent-detection
            context:
              arguments: "${arguments}"
              logging:
                level: "debug"
                auto:
                  node_tracking: true
            next_node: execute_dynamic_route
        explanation: |
          Pass logging config in context to override for this sub-workflow.
          More verbose logging for intent detection debugging.

    related:
      - action
      - conditional
    since: "1.0.0"
    workflow_since: "2.1.0"
