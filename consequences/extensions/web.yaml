# Web Extension Consequences
# Fetching and caching web content

schema_version: "1.1"
category: extensions/web
description: Web fetch and caching operations

consequences:
  # --------------------------------------------------------------------------
  # web_fetch
  # --------------------------------------------------------------------------
  - type: web_fetch
    description:
      brief: Fetch URL content
      detail: |
        Fetches content from a URL using Claude's WebFetch tool. HTML is
        automatically converted to markdown. Supports optional prompt for
        extraction guidance and allow_failure for graceful HTTP error handling.
      notes:
        - Uses Claude's WebFetch tool
        - HTML converted to markdown automatically
        - Prompt guides extraction if specified
        - With allow_failure, HTTP errors populate result but don't fail

    parameters:
      - name: url
        type: string
        required: true
        description: URL to fetch
        interpolatable: true

      - name: store_as
        type: string
        required: true
        description: State field for result
        pattern: "^[a-zA-Z_][a-zA-Z0-9_.\\[\\]]*$"
        interpolatable: false

      - name: allow_failure
        type: boolean
        required: false
        default: false
        description: If true, 4xx/5xx doesn't fail action
        interpolatable: false

      - name: prompt
        type: string
        required: false
        description: Prompt for WebFetch tool to guide extraction
        interpolatable: true

    payload:
      kind: tool_call
      tool: WebFetch

      requires:
        network: true
        timeout_seconds: 60

      provides:
        outputs:
          - field: "${store_as}.status"
            type: number
            description: "HTTP status code"
          - field: "${store_as}.content"
            type: string
            description: "Fetched content (HTML converted to markdown)"
          - field: "${store_as}.url"
            type: string
            description: "URL that was fetched"

      effect: |
        result = WebFetch(
          url: interpolate(url),
          prompt: interpolate(prompt) ?? "Extract the main content"
        )
        stored_result = {
          status: result.status,
          content: result.content,
          url: interpolate(url)
        }
        if not allow_failure and result.status >= 400:
          throw Error("HTTP " + result.status)
        set_state_value(store_as, stored_result)
      state_writes:
        - "${store_as}"
      state_reads: []

    examples:
      - title: Check for llms.txt manifest
        yaml: |
          - type: web_fetch
            url: "${base_url}/llms.txt"
            store_as: computed.manifest_check
            allow_failure: true
        state_after:
          computed:
            manifest_check:
              status: 200
              content: "..."
              url: "https://example.com/llms.txt"

      - title: Fetch with extraction prompt
        yaml: |
          - type: web_fetch
            url: "${doc_url}"
            store_as: computed.page_content
            prompt: "Extract the main documentation content, excluding navigation and footers"

      - title: Fetch and check status
        yaml: |
          - type: web_fetch
            url: "${source_url}/llms.txt"
            store_as: computed.manifest
            allow_failure: true
          - type: evaluate
            expression: "computed.manifest.status == 200"
            set_flag: has_manifest

    related:
      - cache_web_content
    since: "1.0.0"

  # --------------------------------------------------------------------------
  # cache_web_content
  # --------------------------------------------------------------------------
  - type: cache_web_content
    description:
      brief: Save fetched content to cache
      detail: |
        Saves the content from a web fetch result to a cache file.
        Creates parent directories if needed. Optionally stores the
        cache path in state for later reference.
      notes:
        - Creates parent directories if needed
        - Extracts content field from fetch result
        - Optional store_path_as records where file was written

    parameters:
      - name: from
        type: string
        required: true
        description: State field with fetch result
        pattern: "^[a-zA-Z_][a-zA-Z0-9_.\\[\\]]*$"
        interpolatable: false

      - name: dest
        type: string
        required: true
        description: Destination file path
        interpolatable: true

      - name: store_path_as
        type: string
        required: false
        description: State field to store the written path
        pattern: "^[a-zA-Z_][a-zA-Z0-9_.\\[\\]]*$"
        interpolatable: false

    payload:
      kind: composite
      tool: null

      requires:
        tools:
          - name: mkdir
            check_command: "mkdir --version"

      provides:
        outputs:
          - field: "${store_path_as}"
            type: string
            description: "Path where content was written"

      effect: |
        fetch_result = get_state_value(from)
        content = fetch_result.content
        resolved_dest = interpolate(dest)
        mkdir -p dirname(resolved_dest)
        write_file(resolved_dest, content)
        if store_path_as:
          set_state_value(store_path_as, resolved_dest)
      state_writes:
        - "${store_path_as}"
      state_reads:
        - "${from}"

    examples:
      - title: Cache fetched page
        yaml: |
          - type: cache_web_content
            from: computed.fetch_result
            dest: ".cache/web/${source_id}/${computed.slug}.md"
            store_path_as: computed.cached_file

      - title: Fetch and cache pattern
        yaml: |
          - type: web_fetch
            url: "${doc_url}"
            store_as: computed.page
            prompt: "Extract main content"
          - type: cache_web_content
            from: computed.page
            dest: ".cache/web/${source_id}/${slug}.md"
            store_path_as: computed.cached_path

      - title: Batch caching
        yaml: |
          - type: compute
            expression: "url.replace(/[^a-z0-9]/gi, '-')"
            store_as: computed.slug
          - type: web_fetch
            url: "${url}"
            store_as: computed.current_page
          - type: cache_web_content
            from: computed.current_page
            dest: ".cache/web/${source_id}/${computed.slug}.md"

    related:
      - web_fetch
      - write_file
    since: "1.0.0"
