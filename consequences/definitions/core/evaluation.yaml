# Core Expression Evaluation Consequences
# Expression evaluation and computation operations

schema_version: "1.0"
category: core/evaluation
description: Expression evaluation and computation operations

consequences:
  # --------------------------------------------------------------------------
  # evaluate
  # --------------------------------------------------------------------------
  - type: evaluate
    description:
      brief: Evaluate expression and set flag based on result
      detail: |
        Evaluates a boolean expression and stores the result in a flag.
        Used for deriving boolean conditions from state that can then be
        used in conditional node branching.
      notes:
        - Expression must evaluate to boolean
        - Same syntax as evaluate_expression precondition
        - Supports comparison, logical operators, and functions

    parameters:
      - name: expression
        type: string
        required: true
        description: Boolean expression to evaluate
        interpolatable: false

      - name: set_flag
        type: string
        required: true
        description: Flag name to store the result
        pattern: "^[a-zA-Z_][a-zA-Z0-9_]*$"
        interpolatable: false

    payload:
      kind: computation
      tool: null
      effect: |
        result = eval_expression(expression, state)
        state.flags[set_flag] = result
      state_writes:
        - "flags.${set_flag}"
      state_reads: []

    examples:
      - title: Check if array is empty
        yaml: |
          - type: evaluate
            expression: "len(config.sources) == 0"
            set_flag: is_first_source
        state_before:
          config:
            sources: []
          flags: {}
        state_after:
          flags:
            is_first_source: true

      - title: Check string content
        yaml: |
          - type: evaluate
            expression: "computed.source_type == 'git'"
            set_flag: is_git_source
        state_before:
          computed:
            source_type: "git"
        state_after:
          flags:
            is_git_source: true

      - title: Compound conditions
        yaml: |
          - type: evaluate
            expression: "config.sources and len(config.sources) > 0"
            set_flag: has_sources

    related:
      - set_flag
      - compute
    since: "1.0.0"

  # --------------------------------------------------------------------------
  # compute
  # --------------------------------------------------------------------------
  - type: compute
    description:
      brief: Run expression and store result
      detail: |
        Evaluates an expression and stores the computed result in a state
        field. Unlike evaluate, this can return any type (string, number,
        array, object) not just booleans.
      notes:
        - Expression can return any type
        - Supports string operations, array methods, arithmetic
        - Result stored in specified state field

    parameters:
      - name: expression
        type: string
        required: true
        description: Expression to evaluate
        interpolatable: false

      - name: store_as
        type: string
        required: true
        description: State field to store the result
        pattern: "^[a-zA-Z_][a-zA-Z0-9_.\\[\\]]*$"
        interpolatable: false

    payload:
      kind: computation
      tool: null
      effect: |
        result = eval_expression(expression, state)
        set_state_value(store_as, result)
      state_writes:
        - "${store_as}"
      state_reads: []

    examples:
      - title: Extract repo name from URL
        yaml: |
          - type: compute
            expression: "source_url.split('/').pop()"
            store_as: computed.repo_name
        state_before:
          source_url: "https://github.com/hiivmind/blueprint"
        state_after:
          computed:
            repo_name: "blueprint"

      - title: Calculate count
        yaml: |
          - type: compute
            expression: "len(config.sources)"
            store_as: computed.source_count
        state_before:
          config:
            sources:
              - id: main
              - id: docs
        state_after:
          computed:
            source_count: 2

      - title: Construct string
        yaml: |
          - type: compute
            expression: "'hiivmind-corpus-' + computed.project_name"
            store_as: computed.corpus_id
        state_before:
          computed:
            project_name: "polars"
        state_after:
          computed:
            corpus_id: "hiivmind-corpus-polars"

    related:
      - evaluate
      - set_state
    since: "1.0.0"
