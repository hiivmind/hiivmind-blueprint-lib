# Core Utility Consequences
# Timestamp and hash operations

schema_version: "1.0"
category: core/utility
description: Utility operations for timestamps and hashing

consequences:
  # --------------------------------------------------------------------------
  # set_timestamp
  # --------------------------------------------------------------------------
  - type: set_timestamp
    description:
      brief: Set current ISO timestamp
      detail: |
        Stores the current date/time as an ISO 8601 formatted string.
        Used for recording when operations occurred, cache invalidation,
        and audit trails.
      notes:
        - Format: 2025-01-23T14:30:00.000Z
        - Always uses UTC timezone
        - Useful for last_indexed_at, created_at fields

    parameters:
      - name: store_as
        type: string
        required: true
        description: State field for the timestamp
        pattern: "^[a-zA-Z_][a-zA-Z0-9_.\\[\\]]*$"
        interpolatable: false

    payload:
      kind: computation
      tool: null
      effect: |
        timestamp = new Date().toISOString()
        set_state_value(store_as, timestamp)
      state_writes:
        - "${store_as}"
      state_reads: []

    examples:
      - title: Record indexing time
        yaml: |
          - type: set_timestamp
            store_as: computed.indexed_at
        state_before:
          computed: {}
        state_after:
          computed:
            indexed_at: "2025-01-23T14:30:00.000Z"

      - title: Use in config update
        yaml: |
          - type: set_timestamp
            store_as: computed.now
          - type: write_file
            path: config.yaml
            content: "last_updated: ${computed.now}"

      - title: Multiple timestamps for timing
        yaml: |
          - type: set_timestamp
            store_as: computed.start_time
          # ... operations ...
          - type: set_timestamp
            store_as: computed.end_time

    related:
      - compute_hash
      - set_state
    since: "1.0.0"

  # --------------------------------------------------------------------------
  # compute_hash
  # --------------------------------------------------------------------------
  - type: compute_hash
    description:
      brief: Compute SHA-256 hash of content
      detail: |
        Computes a SHA-256 hash of content stored in state. Useful for
        change detection, cache invalidation, and content verification.
        Output includes algorithm prefix.
      notes:
        - Uses SHA-256 algorithm
        - Output format: sha256:abc123def456...
        - The sha256: prefix identifies the algorithm
        - Useful for comparing content versions

    parameters:
      - name: from
        type: string
        required: true
        description: State field containing content to hash
        pattern: "^[a-zA-Z_][a-zA-Z0-9_.\\[\\]]*$"
        interpolatable: false

      - name: store_as
        type: string
        required: true
        description: State field for the hash result
        pattern: "^[a-zA-Z_][a-zA-Z0-9_.\\[\\]]*$"
        interpolatable: false

    payload:
      kind: computation
      tool: null
      effect: |
        content = get_state_value(from)
        hash = sha256(content)
        set_state_value(store_as, "sha256:" + hash)
      state_writes:
        - "${store_as}"
      state_reads:
        - "${from}"

    examples:
      - title: Hash manifest for change detection
        yaml: |
          - type: web_fetch
            url: "${base_url}/llms.txt"
            store_as: computed.manifest
          - type: compute_hash
            from: computed.manifest.content
            store_as: computed.manifest_hash
        state_after:
          computed:
            manifest_hash: "sha256:a1b2c3d4e5f6..."

      - title: Compare with stored hash
        yaml: |
          - type: compute_hash
            from: computed.manifest.content
            store_as: computed.new_hash
          - type: evaluate
            expression: "computed.new_hash != config.sources[0].content_hash"
            set_flag: content_changed

      - title: Hash file content
        yaml: |
          - type: read_file
            path: data/index.md
            store_as: computed.index_content
          - type: compute_hash
            from: computed.index_content
            store_as: computed.index_hash

    related:
      - set_timestamp
      - evaluate
    since: "1.0.0"
