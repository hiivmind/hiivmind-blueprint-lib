# hiivmind-blueprint-types Bundle
# Single-file distribution of all type definitions
#
# Usage: Reference this file directly in workflows:
#   definitions:
#     source: https://github.com/hiivmind/hiivmind-blueprint-types/releases/download/v1.0.0/bundle.yaml

package:
  name: hiivmind-blueprint-types
  version: "1.0.0"
  description: Externalized type definitions for hiivmind-blueprint workflows
  repository: https://github.com/hiivmind/hiivmind-blueprint-types
  license: MIT

schemas:
  consequence: "1.1"
  precondition: "1.0"
  node: "1.0"

# Statistics
stats:
  total_types: 75
  consequence_types: 43
  precondition_types: 27
  node_types: 5
  core_consequence_types: 30
  extension_consequence_types: 13
  core_precondition_types: 22
  extension_precondition_types: 5
  core_node_types: 5

# ============================================================================
# CONSEQUENCES (43 types)
# ============================================================================

consequences:
  schema_version: "1.1"

  # Master lookup table: type -> category
  type_lookup:
    # Core - State (5)
    set_flag: core/state
    set_state: core/state
    append_state: core/state
    clear_state: core/state
    merge_state: core/state

    # Core - Evaluation (2)
    evaluate: core/evaluation
    compute: core/evaluation

    # Core - Interaction (2)
    display_message: core/interaction
    display_table: core/interaction

    # Core - Control (3)
    create_checkpoint: core/control
    rollback_checkpoint: core/control
    spawn_agent: core/control

    # Core - Skill (2)
    invoke_pattern: core/skill
    invoke_skill: core/skill

    # Core - Utility (2)
    set_timestamp: core/utility
    compute_hash: core/utility

    # Core - Intent (4)
    evaluate_keywords: core/intent
    parse_intent_flags: core/intent
    match_3vl_rules: core/intent
    dynamic_route: core/intent

    # Core - Logging (10)
    init_log: core/logging
    log_node: core/logging
    log_event: core/logging
    log_warning: core/logging
    log_error: core/logging
    log_session_snapshot: core/logging
    finalize_log: core/logging
    write_log: core/logging
    apply_log_retention: core/logging
    output_ci_summary: core/logging

    # Extensions - File System (4)
    read_file: extensions/file-system
    write_file: extensions/file-system
    create_directory: extensions/file-system
    delete_file: extensions/file-system

    # Extensions - Git (4)
    clone_repo: extensions/git
    get_sha: extensions/git
    git_pull: extensions/git
    git_fetch: extensions/git

    # Extensions - Web (2)
    web_fetch: extensions/web
    cache_web_content: extensions/web

    # Extensions - Scripting (3)
    run_script: extensions/scripting
    run_python: extensions/scripting
    run_bash: extensions/scripting

  # Categories with brief descriptions
  categories:
    core/state:
      description: State mutation operations
      types: [set_flag, set_state, append_state, clear_state, merge_state]

    core/evaluation:
      description: Expression evaluation and computation
      types: [evaluate, compute]

    core/interaction:
      description: User interaction and display
      types: [display_message, display_table]

    core/control:
      description: Control flow and checkpoints
      types: [create_checkpoint, rollback_checkpoint, spawn_agent]

    core/skill:
      description: Skill and pattern invocation
      types: [invoke_pattern, invoke_skill]

    core/utility:
      description: Utility operations
      types: [set_timestamp, compute_hash]

    core/intent:
      description: 3VL intent detection and routing
      types: [evaluate_keywords, parse_intent_flags, match_3vl_rules, dynamic_route]

    core/logging:
      description: Workflow execution logging
      types: [init_log, log_node, log_event, log_warning, log_error, log_session_snapshot, finalize_log, write_log, apply_log_retention, output_ci_summary]

    extensions/file-system:
      description: File system operations
      types: [read_file, write_file, create_directory, delete_file]

    extensions/git:
      description: Git repository operations
      types: [clone_repo, get_sha, git_pull, git_fetch]

    extensions/web:
      description: Web fetch and caching
      types: [web_fetch, cache_web_content]

    extensions/scripting:
      description: Script execution with interpreter detection
      types: [run_script, run_python, run_bash]

  # Type signatures (minimal for validation, full definitions in separate files)
  types:
    # --- Core State ---
    set_flag:
      brief: Set a boolean flag
      parameters:
        - {name: flag, type: string, required: true}
        - {name: value, type: boolean, required: true}
      payload: {kind: state_mutation}

    set_state:
      brief: Set any state field
      parameters:
        - {name: field, type: string, required: true}
        - {name: value, type: any, required: true}
      payload: {kind: state_mutation}

    append_state:
      brief: Append value to array field
      parameters:
        - {name: field, type: string, required: true}
        - {name: value, type: any, required: true}
      payload: {kind: state_mutation}

    clear_state:
      brief: Reset field to null
      parameters:
        - {name: field, type: string, required: true}
      payload: {kind: state_mutation}

    merge_state:
      brief: Merge object into state field
      parameters:
        - {name: field, type: string, required: true}
        - {name: value, type: object, required: true}
      payload: {kind: state_mutation}

    # --- Core Evaluation ---
    evaluate:
      brief: Evaluate expression and set flag based on result
      parameters:
        - {name: expression, type: string, required: true}
        - {name: set_flag, type: string, required: true}
      payload: {kind: computation}

    compute:
      brief: Run expression and store result
      parameters:
        - {name: expression, type: string, required: true}
        - {name: store_as, type: string, required: true}
      payload: {kind: computation}

    # --- Core Interaction ---
    display_message:
      brief: Show message to user
      parameters:
        - {name: message, type: string, required: true}
      payload: {kind: side_effect}

    display_table:
      brief: Show tabular data to user
      parameters:
        - {name: headers, type: array, required: true}
        - {name: rows, type: any, required: true}
        - {name: title, type: string, required: false}
      payload: {kind: side_effect}

    # --- Core Control ---
    create_checkpoint:
      brief: Save state snapshot for potential rollback
      parameters:
        - {name: name, type: string, required: true}
      payload: {kind: state_mutation}

    rollback_checkpoint:
      brief: Restore state from checkpoint
      parameters:
        - {name: name, type: string, required: true}
      payload: {kind: state_mutation}

    spawn_agent:
      brief: Launch a Task agent for parallel work
      parameters:
        - {name: subagent_type, type: string, required: true}
        - {name: prompt, type: string, required: true}
        - {name: store_as, type: string, required: true}
        - {name: run_in_background, type: boolean, required: false}
      payload: {kind: tool_call, tool: Task}

    # --- Core Skill ---
    invoke_pattern:
      brief: Execute a pattern document section
      parameters:
        - {name: path, type: string, required: true}
        - {name: section, type: string, required: false}
        - {name: context, type: object, required: false}
      payload: {kind: composite}

    invoke_skill:
      brief: Invoke another skill and wait for completion
      parameters:
        - {name: skill, type: string, required: true}
        - {name: args, type: string, required: false}
      payload: {kind: tool_call, tool: Skill}

    # --- Core Utility ---
    set_timestamp:
      brief: Set current ISO timestamp
      parameters:
        - {name: store_as, type: string, required: true}
      payload: {kind: computation}

    compute_hash:
      brief: Compute SHA-256 hash of content
      parameters:
        - {name: from, type: string, required: true}
        - {name: store_as, type: string, required: true}
      payload: {kind: computation}

    # --- Core Intent ---
    evaluate_keywords:
      brief: Match keywords to detect intent
      parameters:
        - {name: input, type: string, required: true}
        - {name: keyword_sets, type: object, required: true}
        - {name: store_as, type: string, required: true}
      payload: {kind: computation}

    parse_intent_flags:
      brief: Parse 3VL flags from user input
      parameters:
        - {name: input, type: string, required: true}
        - {name: flag_definitions, type: object, required: true}
        - {name: store_as, type: string, required: true}
      payload: {kind: computation}

    match_3vl_rules:
      brief: Match 3VL flags against rule table
      parameters:
        - {name: flags, type: object, required: true}
        - {name: rules, type: array, required: true}
        - {name: store_as, type: string, required: true}
      payload: {kind: computation}

    dynamic_route:
      brief: Execute dynamically determined node transition
      parameters:
        - {name: action, type: string, required: true}
      payload: {kind: state_mutation}

    # --- Core Logging ---
    init_log:
      brief: Initialize log structure with workflow metadata
      parameters:
        - {name: workflow_name, type: string, required: true}
        - {name: workflow_version, type: string, required: false}
        - {name: skill_name, type: string, required: false}
        - {name: plugin_name, type: string, required: false}
        - {name: execution_path, type: string, required: false}
      payload: {kind: composite}

    log_node:
      brief: Record node execution in history
      parameters:
        - {name: node, type: string, required: true}
        - {name: outcome, type: string, required: true}
        - {name: details, type: object, required: false}
      payload: {kind: state_mutation}

    log_event:
      brief: Log domain-specific event
      parameters:
        - {name: event_type, type: string, required: true}
        - {name: data, type: object, required: false}
        - {name: level, type: string, required: false}
      payload: {kind: state_mutation}

    log_warning:
      brief: Add warning message to log
      parameters:
        - {name: message, type: string, required: true}
        - {name: context, type: object, required: false}
        - {name: node, type: string, required: false}
      payload: {kind: state_mutation}

    log_error:
      brief: Add error with context to log
      parameters:
        - {name: message, type: string, required: true}
        - {name: error_type, type: string, required: false}
        - {name: context, type: object, required: false}
        - {name: node, type: string, required: false}
        - {name: recoverable, type: boolean, required: false}
      payload: {kind: state_mutation}

    log_session_snapshot:
      brief: Record mid-session checkpoint
      parameters:
        - {name: description, type: string, required: true}
        - {name: write_intermediate, type: boolean, required: false}
        - {name: node, type: string, required: false}
      payload: {kind: composite}

    finalize_log:
      brief: Complete log with timing and outcome
      parameters:
        - {name: outcome, type: string, required: true}
        - {name: ending_node, type: string, required: false}
        - {name: summary, type: string, required: false}
      payload: {kind: state_mutation}

    write_log:
      brief: Write log to file
      parameters:
        - {name: format, type: string, required: false}
        - {name: path, type: string, required: false}
        - {name: include_node_history, type: boolean, required: false}
        - {name: include_events, type: boolean, required: false}
      payload: {kind: side_effect}

    apply_log_retention:
      brief: Clean up old log files
      parameters:
        - {name: path, type: string, required: true}
        - {name: strategy, type: string, required: true}
        - {name: days, type: number, required: false}
        - {name: count, type: number, required: false}
        - {name: pattern, type: string, required: false}
      payload: {kind: side_effect}

    output_ci_summary:
      brief: Format output for CI environments
      parameters:
        - {name: format, type: string, required: false}
        - {name: annotations, type: boolean, required: false}
        - {name: output_file, type: string, required: false}
      payload: {kind: side_effect}

    # --- Extensions - File System ---
    read_file:
      brief: Read arbitrary file content
      parameters:
        - {name: path, type: string, required: true}
        - {name: store_as, type: string, required: true}
      payload: {kind: tool_call, tool: Read}

    write_file:
      brief: Write content to file
      parameters:
        - {name: path, type: string, required: true}
        - {name: content, type: string, required: true}
      payload: {kind: tool_call, tool: Write}

    create_directory:
      brief: Create directory including parents
      parameters:
        - {name: path, type: string, required: true}
      payload: {kind: tool_call, tool: Bash}

    delete_file:
      brief: Delete file if exists
      parameters:
        - {name: path, type: string, required: true}
      payload: {kind: tool_call, tool: Bash}

    # --- Extensions - Git ---
    clone_repo:
      brief: Clone git repository
      parameters:
        - {name: url, type: string, required: true}
        - {name: dest, type: string, required: true}
        - {name: branch, type: string, required: false}
        - {name: depth, type: number, required: false}
      payload: {kind: tool_call, tool: Bash}

    get_sha:
      brief: Get HEAD commit SHA
      parameters:
        - {name: repo_path, type: string, required: true}
        - {name: store_as, type: string, required: true}
      payload: {kind: tool_call, tool: Bash}

    git_pull:
      brief: Pull latest changes
      parameters:
        - {name: repo_path, type: string, required: true}
      payload: {kind: tool_call, tool: Bash}

    git_fetch:
      brief: Fetch remote refs
      parameters:
        - {name: repo_path, type: string, required: true}
      payload: {kind: tool_call, tool: Bash}

    # --- Extensions - Web ---
    web_fetch:
      brief: Fetch URL content
      parameters:
        - {name: url, type: string, required: true}
        - {name: store_as, type: string, required: true}
        - {name: allow_failure, type: boolean, required: false}
        - {name: prompt, type: string, required: false}
      payload: {kind: tool_call, tool: WebFetch}

    cache_web_content:
      brief: Save fetched content to cache
      parameters:
        - {name: from, type: string, required: true}
        - {name: dest, type: string, required: true}
        - {name: store_path_as, type: string, required: false}
      payload: {kind: composite}

    # --- Extensions - Scripting ---
    run_script:
      brief: Execute script with auto-detected interpreter
      parameters:
        - {name: script, type: string, required: true}
        - {name: args, type: array, required: false}
        - {name: store_as, type: string, required: false}
        - {name: working_directory, type: string, required: false}
      payload: {kind: tool_call, tool: Bash}

    run_python:
      brief: Execute Python script
      parameters:
        - {name: script, type: string, required: true}
        - {name: args, type: array, required: false}
        - {name: venv, type: string, required: false}
        - {name: store_as, type: string, required: false}
      payload: {kind: tool_call, tool: Bash}

    run_bash:
      brief: Execute Bash script
      parameters:
        - {name: script, type: string, required: true}
        - {name: args, type: array, required: false}
        - {name: env, type: object, required: false}
        - {name: store_as, type: string, required: false}
      payload: {kind: tool_call, tool: Bash}


# ============================================================================
# PRECONDITIONS (27 types)
# ============================================================================

preconditions:
  schema_version: "1.0"

  # Master lookup table: type -> category
  type_lookup:
    # Core - Filesystem (5)
    config_exists: core/filesystem
    index_exists: core/filesystem
    index_is_placeholder: core/filesystem
    file_exists: core/filesystem
    directory_exists: core/filesystem

    # Core - State (8)
    flag_set: core/state
    flag_not_set: core/state
    state_equals: core/state
    state_not_null: core/state
    state_is_null: core/state
    count_equals: core/state
    count_above: core/state
    count_below: core/state

    # Core - Tool (2)
    tool_available: core/tool
    python_module_available: core/tool

    # Core - Composite (3)
    all_of: core/composite
    any_of: core/composite
    none_of: core/composite

    # Core - Expression (1)
    evaluate_expression: core/expression

    # Core - Logging (3)
    log_initialized: core/logging
    log_level_enabled: core/logging
    log_finalized: core/logging

    # Extensions - Source (3)
    source_exists: extensions/source
    source_cloned: extensions/source
    source_has_updates: extensions/source

    # Extensions - Web (2)
    fetch_succeeded: extensions/web
    fetch_returned_content: extensions/web

  # Categories with brief descriptions
  categories:
    core/filesystem:
      description: File and directory existence checks
      types: [config_exists, index_exists, index_is_placeholder, file_exists, directory_exists]

    core/state:
      description: State inspection and comparison
      types: [flag_set, flag_not_set, state_equals, state_not_null, state_is_null, count_equals, count_above, count_below]

    core/tool:
      description: Tool and module availability
      types: [tool_available, python_module_available]

    core/composite:
      description: Logical composition (AND, OR, NOR)
      types: [all_of, any_of, none_of]

    core/expression:
      description: Arbitrary expression evaluation
      types: [evaluate_expression]

    core/logging:
      description: Logging lifecycle checks
      types: [log_initialized, log_level_enabled, log_finalized]

    extensions/source:
      description: Source repository checks
      types: [source_exists, source_cloned, source_has_updates]

    extensions/web:
      description: Web fetch result verification
      types: [fetch_succeeded, fetch_returned_content]

  # Type signatures (minimal for validation, full definitions in separate files)
  types:
    # --- Core Filesystem ---
    config_exists:
      brief: Check if corpus config.yaml exists
      parameters: []

    index_exists:
      brief: Check if corpus index.md exists
      parameters: []

    index_is_placeholder:
      brief: Check if index contains placeholder text
      parameters: []

    file_exists:
      brief: Check if arbitrary file exists
      parameters:
        - {name: path, type: string, required: true}

    directory_exists:
      brief: Check if directory exists
      parameters:
        - {name: path, type: string, required: true}

    # --- Core State ---
    flag_set:
      brief: Check if a boolean flag is true
      parameters:
        - {name: flag, type: string, required: true}

    flag_not_set:
      brief: Check if a boolean flag is false or undefined
      parameters:
        - {name: flag, type: string, required: true}

    state_equals:
      brief: Check if state field equals specific value
      parameters:
        - {name: field, type: string, required: true}
        - {name: value, type: any, required: true}

    state_not_null:
      brief: Check if state field has a value
      parameters:
        - {name: field, type: string, required: true}

    state_is_null:
      brief: Check if state field is null or undefined
      parameters:
        - {name: field, type: string, required: true}

    count_equals:
      brief: Check if array length equals value
      parameters:
        - {name: field, type: string, required: true}
        - {name: count, type: number, required: true}

    count_above:
      brief: Check if array length exceeds threshold
      parameters:
        - {name: field, type: string, required: true}
        - {name: min, type: number, required: true}

    count_below:
      brief: Check if array length is below threshold
      parameters:
        - {name: field, type: string, required: true}
        - {name: max, type: number, required: true}

    # --- Core Tool ---
    tool_available:
      brief: Check if CLI tool is available
      parameters:
        - {name: tool, type: string, required: true}

    python_module_available:
      brief: Check if Python module can be imported
      parameters:
        - {name: module, type: string, required: true}

    # --- Core Composite ---
    all_of:
      brief: All nested preconditions must be true (AND)
      parameters:
        - {name: conditions, type: array, required: true}

    any_of:
      brief: At least one nested precondition must be true (OR)
      parameters:
        - {name: conditions, type: array, required: true}

    none_of:
      brief: No nested precondition may be true (NOR)
      parameters:
        - {name: conditions, type: array, required: true}

    # --- Core Expression ---
    evaluate_expression:
      brief: Evaluate arbitrary boolean expression
      parameters:
        - {name: expression, type: string, required: true}

    # --- Core Logging ---
    log_initialized:
      brief: Check if logging has been initialized
      parameters: []

    log_level_enabled:
      brief: Check if log level is enabled
      parameters:
        - {name: level, type: string, required: true}

    log_finalized:
      brief: Check if logging has been finalized
      parameters: []

    # --- Extensions - Source ---
    source_exists:
      brief: Check if source is configured
      parameters:
        - {name: source_id, type: string, required: true}

    source_cloned:
      brief: Check if source has been cloned
      parameters:
        - {name: source_id, type: string, required: true}

    source_has_updates:
      brief: Check if source has upstream changes
      parameters:
        - {name: source_id, type: string, required: true}

    # --- Extensions - Web ---
    fetch_succeeded:
      brief: Check if web fetch returned 2xx status
      parameters:
        - {name: result_field, type: string, required: true}

    fetch_returned_content:
      brief: Check if web fetch returned non-empty content
      parameters:
        - {name: result_field, type: string, required: true}


# ============================================================================
# NODES (5 types)
# ============================================================================

nodes:
  schema_version: "1.0"

  # Master lookup table: type -> category
  type_lookup:
    action: core
    conditional: core
    user_prompt: core
    validation_gate: core
    reference: core

  # Categories
  categories:
    core:
      description: Fundamental node types for workflow execution
      types: [action, conditional, user_prompt, validation_gate, reference]

  # Type signatures (minimal for validation, full definitions in separate files)
  types:
    action:
      brief: Executes operations and routes based on success/failure
      fields:
        - {name: type, type: string, required: true, value: "action"}
        - {name: description, type: string, required: false}
        - {name: actions, type: array, required: true, items: consequence}
        - {name: on_success, type: node_reference, required: true}
        - {name: on_failure, type: node_reference, required: true}

    conditional:
      brief: Branches based on a precondition evaluation
      fields:
        - {name: type, type: string, required: true, value: "conditional"}
        - {name: description, type: string, required: false}
        - {name: condition, type: precondition, required: true}
        - {name: branches, type: object, required: true}

    user_prompt:
      brief: Presents an AskUserQuestion and routes based on response
      fields:
        - {name: type, type: string, required: true, value: "user_prompt"}
        - {name: prompt, type: object, required: true}
        - {name: on_response, type: object, required: true}

    validation_gate:
      brief: Runs multiple preconditions; all must pass to proceed
      fields:
        - {name: type, type: string, required: true, value: "validation_gate"}
        - {name: description, type: string, required: false}
        - {name: validations, type: array, required: true}
        - {name: on_valid, type: node_reference, required: true}
        - {name: on_invalid, type: node_reference, required: true}

    reference:
      brief: Loads and executes a reference document section
      fields:
        - {name: type, type: string, required: true, value: "reference"}
        - {name: doc, type: string, required: true}
        - {name: section, type: string, required: false}
        - {name: context, type: object, required: false}
        - {name: next_node, type: node_reference, required: true}
