{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://raw.githubusercontent.com/hiivmind/hiivmind-blueprint-lib/main/schema/precondition-definition.json",
  "$comment": "Schema version 3.0 - Consolidated types with operator/capability/aspect parameters",
  "title": "Precondition Definition Schema",
  "description": "Schema for YAML precondition definition files",
  "type": "object",
  "required": ["schema_version", "category", "description", "preconditions"],
  "additionalProperties": false,
  "properties": {
    "schema_version": {
      "$ref": "../common.json#/$defs/semver_short",
      "description": "Schema version (semver major.minor)"
    },
    "category": {
      "$ref": "../common.json#/$defs/category_path"
    },
    "description": {
      "type": "string",
      "description": "Brief description of this category"
    },
    "preconditions": {
      "type": "object",
      "minProperties": 1,
      "additionalProperties": {
        "$ref": "#/$defs/precondition"
      },
      "description": "Precondition definitions keyed by type name"
    }
  },
  "$defs": {
    "precondition": {
      "type": "object",
      "required": ["category", "description", "parameters", "evaluation"],
      "additionalProperties": false,
      "properties": {
        "category": {
          "$ref": "../common.json#/$defs/category_path",
          "description": "Category path for this precondition type"
        },
        "description": {
          "$ref": "#/$defs/preconditionDescription"
        },
        "parameters": {
          "type": "array",
          "items": {
            "$ref": "../common.json#/$defs/parameter"
          }
        },
        "evaluation": {
          "$ref": "#/$defs/evaluation"
        },
        "examples": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/example"
          }
        },
        "related": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Related precondition types"
        },
        "since": {
          "$ref": "../common.json#/$defs/semver",
          "description": "Version when this precondition was introduced"
        },
        "replaces": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "List of deprecated type names this type replaces"
        }
      }
    },
    "preconditionDescription": {
      "type": "object",
      "required": ["brief"],
      "additionalProperties": false,
      "properties": {
        "brief": {
          "type": "string",
          "maxLength": 100,
          "description": "One-line description"
        },
        "detail": {
          "type": "string",
          "description": "Extended description with markdown"
        },
        "notes": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Additional notes and caveats"
        }
      }
    },
    "evaluation": {
      "type": "object",
      "required": ["effect"],
      "additionalProperties": false,
      "description": "Describes how the precondition is evaluated (pure boolean, no side effects)",
      "properties": {
        "effect": {
          "type": "string",
          "description": "Pseudocode describing the boolean evaluation"
        },
        "reads": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "State or file paths read during evaluation"
        },
        "functions": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Built-in functions used (e.g., file_exists, len)"
        }
      }
    },
    "example": {
      "type": "object",
      "required": ["title", "yaml"],
      "additionalProperties": false,
      "properties": {
        "title": {
          "type": "string",
          "description": "Example title"
        },
        "yaml": {
          "type": "string",
          "description": "YAML example code"
        },
        "context": {
          "type": "object",
          "description": "Context in which evaluation occurs",
          "properties": {
            "state": {
              "type": "object",
              "description": "Relevant state for evaluation"
            },
            "files": {
              "type": "object",
              "description": "Relevant files and their existence/content"
            }
          }
        },
        "result": {
          "type": "boolean",
          "description": "Expected evaluation result"
        }
      }
    }
  }
}
